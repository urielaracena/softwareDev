{% extends "base.html" %}
{% block title %}Checkout - Elegant Salon{% endblock %}

{% block content %}
<div class="container py-5">
  <main>
    <div class="py-5 text-center">
      <h1 class="h2 display-5">Book an Appointment</h1>
      <p class="lead">Review your selected services, choose a time, and provide payment details to confirm your appointment.</p>
    </div>

    <div class="row g-5">
      <!-- Cart Summary -->
      <div class="col-md-5 col-lg-4 order-md-last">
        <h4 class="d-flex justify-content-between align-items-center mb-3">
          <span class="text-primary">Your Cart</span>
          <span class="badge bg-primary rounded-pill">{{ cart_items|length }}</span>
        </h4>
        <ul class="list-group mb-3">
          {% if cart_items %}
            {% for item in cart_items %}
              <li class="list-group-item d-flex justify-content-between lh-sm">
                <div>
                  <h6 class="my-0">{{ item.name }}</h6>
                  <small class="text-body-secondary">{{ item.duration }} min</small>
                </div>
                <span class="text-body-secondary">${{ "%.2f"|format(item.price) }}</span>
              </li>
            {% endfor %}
            <li class="list-group-item d-flex justify-content-between">
              <span>Total (USD)</span>
              <strong>${{ "%.2f"|format(total_price) }}</strong>
            </li>
          {% else %}
            <li class="list-group-item">
              <p>Your cart is empty. <a href="{{ url_for('all_services') }}">Add services</a>.</p>
            </li>
          {% endif %}
        </ul>
        {% if cart_items %}
          <div class="d-flex justify-content-between mb-3">
            <a href="{{ url_for('all_services') }}" class="btn btn-primary">+ Add More</a>
            <form action="{{ url_for('clear_cart') }}" method="post">
              <button type="submit" class="btn btn-primary">Clear All</button>
            </form>
          </div>
        {% endif %}
      </div>

      <!-- Checkout Form -->
      <div class="col-md-7 col-lg-8">
        <h4 class="mb-3 text-center">Appointment & Billing Details</h4>
        {% if cart_items %}
          <form class="needs-validation" method="POST" action="{{ url_for('checkout') }}" novalidate>
            <!-- Appointment Details -->
            <h5 class="mb-3 text-center">Appointment</h5>
            <div class="row g-3">
              <div class="col-sm-6">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" name="date" id="date" required min="{{ min_date }}">
                <div class="invalid-feedback">Please select a valid date.</div>
              </div>
              <div class="col-sm-6">
                <label for="time" class="form-label">Time</label>
                <select name="time" id="time" class="form-select" required>
                  <option value="">Select a time</option>
                  {% for slot in available_times %}
                    <option value="{{ slot }}">{{ slot }}</option>
                  {% endfor %}
                </select>
                <div class="invalid-feedback">Please select a time.</div>
              </div>
              <div class="col-12">
                <label for="notes" class="form-label">Notes (optional)</label>
                <textarea name="notes" class="form-control" id="notes" rows="3"></textarea>
              </div>
            </div>

            <hr class="my-4">

            <!-- Billing Address -->
            <h5 class="mb-3 text-center">Billing Address</h5>
            <div class="row g-3">
              <div class="col-sm-6">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" name="firstName" required>
                <div class="invalid-feedback">Valid first name is required.</div>
              </div>
              <div class="col-sm-6">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" name="lastName" required>
                <div class="invalid-feedback">Valid last name is required.</div>
              </div>
              <div class="col-12">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required>
                <div class="invalid-feedback">Please enter a valid email address.</div>
              </div>
              <div class="col-12">
                <label for="address" class="form-label">Address</label>
                <input type="text" class="form-control" id="address" name="address" placeholder="1234 Main St" required>
                <div class="invalid-feedback">Please enter your address.</div>
              </div>
              <div class="col-md-5">
                <label for="country" class="form-label">Country</label>
                <select class="form-select" id="country" name="country" required>
                  <option value="">Choose...</option>
                  <option>United States</option>
                </select>
                <div class="invalid-feedback">Please select a valid country.</div>
              </div>
              <div class="col-md-4">
                <label for="state" class="form-label">State</label>
                <select class="form-select" id="state" name="state" required>
                  <option value="">Choose...</option>
                  <option>California</option>
                </select>
                <div class="invalid-feedback">Please provide a valid state.</div>
              </div>
              <div class="col-md-3">
                <label for="zip" class="form-label">Zip</label>
                <input type="text" class="form-control" id="zip" name="zip" required>
                <div class="invalid-feedback">Zip code required.</div>
              </div>
            </div>

            <hr class="my-4">

            <!-- Payment Method -->
            <h5 class="mb-3 text-center">Payment</h5>
            <div class="my-3">
              <div class="form-check">
                <input id="credit" name="paymentMethod" type="radio" class="form-check-input" checked required>
                <label class="form-check-label" for="credit">Credit Card</label>
              </div>
              <div class="form-check">
                <input id="debit" name="paymentMethod" type="radio" class="form-check-input" required>
                <label class="form-check-label" for="debit">Debit Card</label>
              </div>
              <div class="form-check">
                <input id="paypal" name="paymentMethod" type="radio" class="form-check-input" required>
                <label class="form-check-label" for="paypal">PayPal</label>
              </div>
            </div>
            <div class="row gy-3">
              <div class="col-md-6">
                <label for="cc-name" class="form-label">Name on Card</label>
                <input type="text" class="form-control" id="cc-name" name="cc-name" required>
                <small class="text-body-secondary">Full name as displayed on card</small>
                <div class="invalid-feedback">Name on card is required.</div>
              </div>
              <div class="col-md-6">
                <label for="cc-number" class="form-label">Card Number</label>
                <input type="text" class="form-control" id="cc-number" name="cc-number" required>
                <div class="invalid-feedback">Card number is required.</div>
              </div>
              <div class="col-md-3">
                <label for="cc-expiration" class="form-label">Expiration</label>
                <input type="text" class="form-control" id="cc-expiration" name="cc-expiration" required>
                <div class="invalid-feedback">Expiration date required.</div>
              </div>
              <div class="col-md-3">
                <label for="cc-cvv" class="form-label">CVV</label>
                <input type="text" class="form-control" id="cc-cvv" name="cc-cvv" required>
                <div class="invalid-feedback">Security code required.</div>
              </div>
            </div>

            <hr class="my-4">
            <button class="w-100 btn btn-primary btn-lg" type="submit">Confirm Booking</button>
          </form>
        {% else %}
          <div class="alert alert-warning">Add services to proceed with booking.</div>
        {% endif %}
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('date');
  const timeSelect = document.getElementById('time');
  const form = document.querySelector('.needs-validation');

  if (dateInput) {
    dateInput.addEventListener('change', function() {
      fetch(`/get-available-times?date=${this.value}`)
        .then(res => res.json())
        .then(data => {
          timeSelect.innerHTML = '<option value="">Select a time</option>';
          data.times.forEach(slot => {
            const option = document.createElement('option');
            option.value = slot;
            option.textContent = slot;
            timeSelect.appendChild(option);
          });
        })
        .catch(err => console.error(err));
    });
  }

  // Bootstrap form validation
  form.addEventListener('submit', function(event) {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
  }, false);
});
</script>
{% endblock %}